{% extends 'base.html' %}
{% load static %}

{% block title %}Edit Family Positions - {{ area.area_name }}{% endblock %}

{% block extra_css %}
<style>
    .sortable-list {
        list-style: none;
        padding: 0;
    }
    .sortable-item {
        padding: 15px;
        margin: 8px 0;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        cursor: move;
        display: flex;
        align-items: center;
    }
    .sortable-item.sortable-ghost {
        opacity: 0.5;
        background: #f8f9fa;
    }
    .position-number {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        background: #e9ecef;
        border-radius: 50%;
        margin-right: 15px;
        font-weight: 500;
    }
    .family-info {
        flex: 1;
    }
    .nav-breadcrumb {
        font-size: 14px;
        color: #6c757d;
        margin-bottom: 1rem;
    }
    .nav-breadcrumb a {
        color: #6c757d;
        text-decoration: none;
    }
    .nav-breadcrumb a:hover {
        color: #0d6efd;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-3">
    <!-- Navigation -->
    <div class="nav-breadcrumb mb-3">
        <a href="{% url 'congregation:pastorate_list' %}">Pastorates</a> › 
        <a href="{% url 'congregation:pastorate_detail' pk=area.church.pastorate.pk %}">{{ area.church.pastorate.pastorate_name }}</a> › 
        <a href="{% url 'congregation:church_detail' pk=area.church.pk %}">{{ area.church.church_name }}</a> › 
        <a href="{% url 'congregation:area_detail' pk=area.pk %}">{{ area.area_name }}</a> › 
        <span>Edit Positions</span>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Edit Family Positions - {{ area.area_name }}</h2>
        <a href="{% url 'congregation:area_detail' pk=area.pk %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Area
        </a>
    </div>

    {% csrf_token %}
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">Drag and Drop Families to Reorder</h5>
        </div>
        <div class="card-body">
            <ul id="familyList" class="sortable-list">
                {% for family in families %}
                <li class="sortable-item" data-id="{{ family.id }}">
                    <span class="position-number">{{ family.position_no|default:"-" }}</span>
                    <div class="family-info">
                        <strong>{{ family.family_id }}</strong> - 
                        {{ family.respect.name }} {{ family.initial }} {{ family.family_head }}
                        <small class="text-muted ms-2">({{ family.address }})</small>
                    </div>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var el = document.getElementById('familyList');
    var sortable = new Sortable(el, {
        animation: 150,
        onEnd: function(evt) {
            // Get the new order
            var items = el.getElementsByTagName('li');
            var positions = Array.from(items).map(item => item.dataset.id);

            // Update position numbers visually immediately
            items.forEach((item, index) => {
                const posNum = index + 1;
                item.querySelector('.position-number').textContent = posNum;
            });

            // Send to server
            fetch('{% url "congregation:area_position_edit" pk=area.pk %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: 'positions[]=' + positions.join('&positions[]=')
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    // Show success toast
                    const toast = document.createElement('div');
                    toast.className = 'position-fixed bottom-0 end-0 p-3';
                    toast.style.zIndex = '5';
                    toast.innerHTML = `
                        <div class="toast show" role="alert">
                            <div class="toast-header bg-success text-white">
                                <strong class="me-auto">Success</strong>
                                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                            </div>
                            <div class="toast-body">
                                Family positions updated successfully
                            </div>
                        </div>
                    `;
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 3000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Show error toast
                const toast = document.createElement('div');
                toast.className = 'position-fixed bottom-0 end-0 p-3';
                toast.style.zIndex = '5';
                toast.innerHTML = `
                    <div class="toast show" role="alert">
                        <div class="toast-header bg-danger text-white">
                            <strong class="me-auto">Error</strong>
                            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                        </div>
                        <div class="toast-body">
                            Failed to update family positions
                        </div>
                    </div>
                `;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            });
        }
    });
});
</script>
{% endblock %} 