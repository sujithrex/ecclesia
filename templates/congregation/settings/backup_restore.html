{% extends 'base.html' %}

{% block title %}Backup & Restore - Settings{% endblock %}

{% block extra_css %}
<style>
    .upload-progress {
        display: none;
        margin-top: 20px;
    }
    .validation-results {
        display: none;
        margin-top: 20px;
    }
</style>
{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'web:dashboard' %}">Home</a></li>
<li class="breadcrumb-item"><a href="{% url 'congregation:essentials' %}">Settings</a></li>
<li class="breadcrumb-item active">Backup & Restore</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Backup Section -->
        <div class="col-md-6 mb-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Backup Database</h6>
                </div>
                <div class="card-body">
                    <p class="mb-4">
                        Download a complete backup of your church database in CSV format. 
                        This backup includes all member details, family information, and their relationships.
                    </p>
                    <div class="alert alert-info mb-4">
                        <i class="fas fa-info-circle me-2"></i>
                        The backup will include all members, families, fellowships, areas, churches, and pastorates.
                    </div>
                    <a href="{% url 'congregation:generate_backup' %}" class="btn btn-primary">
                        <i class="fas fa-download me-2"></i>Download Backup
                    </a>
                </div>
            </div>
        </div>

        <!-- Restore Section -->
        <div class="col-md-6 mb-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Restore Database</h6>
                </div>
                <div class="card-body">
                    <form id="restoreForm" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <p class="mb-4">Upload a CSV backup file to restore your database. The file will be validated before restoration.</p>
                        <div class="alert alert-warning mb-4">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Please ensure you have downloaded a backup before proceeding with restore.
                        </div>
                        
                        <div class="mb-3">
                            <label for="csvFile" class="form-label">Select Backup File (CSV)</label>
                            <input type="file" class="form-control" id="csvFile" name="csv_file" accept=".csv" required>
                        </div>
                        
                        <button type="submit" class="btn btn-primary" id="validateButton">
                            <i class="fas fa-check-circle me-2"></i>Validate File
                        </button>
                    </form>

                    <!-- Upload Progress -->
                    <div class="upload-progress">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted mt-2">Validating file...</small>
                    </div>

                    <!-- Validation Results -->
                    <div class="validation-results mt-4">
                        <div class="alert alert-info">
                            <h6 class="alert-heading"><i class="fas fa-spinner fa-spin me-2"></i>Validation in Progress</h6>
                            <p class="mb-0">Please wait while we validate your backup file...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Get CSRF token from cookie
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    $('#restoreForm').on('submit', function(e) {
        e.preventDefault();
        
        // Show progress
        $('.upload-progress').show();
        $('.validation-results').show();
        $('#validateButton').prop('disabled', true);
        
        // Create FormData object
        var formData = new FormData(this);
        
        // Send AJAX request
        $.ajax({
            url: "{% url 'congregation:validate_restore' %}",
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            xhr: function() {
                var xhr = new window.XMLHttpRequest();
                xhr.upload.addEventListener("progress", function(evt) {
                    if (evt.lengthComputable) {
                        var percentComplete = evt.loaded / evt.total;
                        $('.progress-bar').css('width', percentComplete * 100 + '%');
                    }
                }, false);
                return xhr;
            },
            success: function(response) {
                // Redirect to validation results page
                window.location.href = response.redirect_url;
            },
            error: function(xhr, status, error) {
                let errorMessage = 'Failed to upload file. Please try again.';
                try {
                    const response = JSON.parse(xhr.responseText);
                    errorMessage = response.error || errorMessage;
                } catch (e) {
                    console.error('Error parsing response:', xhr.responseText);
                }
                
                $('.validation-results').html(`
                    <div class="alert alert-danger">
                        <h6 class="alert-heading"><i class="fas fa-exclamation-circle me-2"></i>Error</h6>
                        <p class="mb-0">${errorMessage}</p>
                    </div>
                `);
                $('#validateButton').prop('disabled', false);
                $('.upload-progress').hide();
            }
        });
    });
});
</script>
{% endblock %} 