{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'web:dashboard' %}">Home</a></li>
<li class="breadcrumb-item"><a href="{% url 'reports:essentials' %}">Reports</a></li>
<li class="breadcrumb-item active">Family Report</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h4 class="card-title mb-0">{{ title }}</h4>
                </div>
                <div class="card-body">
                    {% if form.errors %}
                    <div class="alert alert-danger">
                        <h5>Please correct the errors below:</h5>
                        {{ form.non_field_errors }}
                        {% for field in form %}
                            {% if field.errors %}
                                <div class="mb-2">
                                    <strong>{{ field.label }}:</strong>
                                    {{ field.errors }}
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <form method="post" class="needs-validation" novalidate>
                        {% csrf_token %}
                        
                        <!-- Selection Information -->
                        <div class="form-section mb-4">
                            <h5 class="form-section-title">Select Church</h5>
                            
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="{{ form.pastorate.id_for_label }}" class="form-label">Pastorate</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-church"></i></span>
                                        {{ form.pastorate }}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="{{ form.church.id_for_label }}" class="form-label">Church</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-building-columns"></i></span>
                                        {{ form.church }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-actions mt-4">
                            <div class="d-flex gap-3">
                                <button type="submit" name="action" value="download" class="btn btn-info">
                                    <i class="fas fa-download me-2"></i>Generate PDF
                                </button>
                                <button type="submit" name="action" value="view" class="btn btn-outline-info">
                                    <i class="fas fa-eye me-2"></i>View PDF
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<style>
    /* Form styling */
    .form-control {
        height: 45px;
        border-radius: 0;
        border-color: #ced4da;
        font-size: 0.95rem;
    }
    
    .form-control:focus {
        border-color: var(--info);
        box-shadow: 0 0 0 0.2rem rgba(23, 162, 184, 0.15);
    }
    
    .input-group-text {
        background-color: #f8f9fa;
        border-radius: 0;
        border-right: none;
        color: #6c757d;
    }
    
    .input-group .form-control {
        border-left: none;
    }
    
    .form-label {
        font-weight: 500;
        color: #495057;
        margin-bottom: 0.5rem;
    }
    
    /* Section styling */
    .form-section {
        border: 1px solid #e9ecef;
        border-radius: 0.25rem;
        padding: 1.5rem;
        background-color: #fff;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    
    .form-section-title {
        color: var(--info);
        font-weight: 600;
        font-size: 1.1rem;
        margin-bottom: 1.25rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid #e9ecef;
    }
    
    /* Button styling */
    .form-actions {
        padding-top: 1rem;
        border-top: 1px solid #e9ecef;
    }
    
    .btn-info {
        padding: 0.6rem 2rem;
        font-weight: 500;
        border-radius: 0.25rem;
    }
    
    .btn-outline-info {
        padding: 0.6rem 2rem;
        font-weight: 500;
        border-radius: 0.25rem;
    }
    
    /* Card styling */
    .card {
        border: none;
        box-shadow: 0 0 15px rgba(0,0,0,0.05);
        border-radius: 0.5rem;
        margin-bottom: 2rem;
    }
    
    .card-header {
        background-color: #fff;
        border-bottom: 1px solid #e9ecef;
        padding: 1.25rem 1.5rem;
    }
    
    .card-body {
        padding: 1.5rem;
    }

    /* Select2 customization */
    .select2-container--bootstrap-5 .select2-selection {
        height: 45px;
        border-radius: 0;
        border-color: #ced4da;
        border-left: none;
    }

    .select2-container--bootstrap-5 .select2-selection--single {
        padding-top: 10px;
    }

    .select2-container--bootstrap-5 .select2-selection--single .select2-selection__arrow {
        height: 43px;
    }

    .select2-container--bootstrap-5 .select2-dropdown {
        border-radius: 0;
    }

    .select2-container--bootstrap-5 .select2-results__option--highlighted[aria-selected] {
        background-color: var(--info);
    }

    .select2-container--bootstrap-5.select2-container--focus .select2-selection {
        border-color: var(--info);
        box-shadow: 0 0 0 0.2rem rgba(23, 162, 184, 0.15);
    }

    .input-group .select2-container {
        flex: 1 1 auto;
        width: 1% !important;
    }

    .select2-container--bootstrap-5 .select2-selection--single .select2-selection__rendered {
        padding-left: 5px;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Select2 for pastorate and church
        $('#{{ form.pastorate.id_for_label }}').select2({
            theme: 'bootstrap-5',
            placeholder: 'Select Pastorate',
            allowClear: true,
            width: '100%'
        });

        $('#{{ form.church.id_for_label }}').select2({
            theme: 'bootstrap-5',
            placeholder: 'Select Church',
            allowClear: true,
            width: '100%'
        });

        // Handle pastorate change
        $('#{{ form.pastorate.id_for_label }}').on('change', function() {
            const pastorateId = $(this).val();
            const churchSelect = $('#{{ form.church.id_for_label }}');
            
            // Clear and disable church select if no pastorate is selected
            if (!pastorateId) {
                churchSelect.empty().prop('disabled', true).trigger('change');
                return;
            }

            // Enable church select and fetch churches
            churchSelect.prop('disabled', false);

            // Show loading state
            churchSelect.empty().append('<option value="">Loading churches...</option>').trigger('change');

            // Fetch churches for selected pastorate
            fetch(`/congregation/api/churches/?pastorate=${pastorateId}`)
                .then(response => response.json())
                .then(data => {
                    // Clear loading state
                    churchSelect.empty();
                    
                    // Add placeholder
                    churchSelect.append(new Option('Select Church', '', true, true));
                    
                    // Add churches
                    data.forEach(church => {
                        churchSelect.append(new Option(church.church_name, church.id, false, false));
                    });
                    
                    // Trigger change to update Select2
                    churchSelect.trigger('change');
                })
                .catch(error => {
                    console.error('Error fetching churches:', error);
                    churchSelect.empty().append('<option value="">Error loading churches</option>').trigger('change');
                });
        });

        // Focus effect for input groups
        const inputGroups = document.querySelectorAll('.input-group');
        inputGroups.forEach(group => {
            const select2Container = group.querySelector('.select2-container');
            const inputGroupText = group.querySelector('.input-group-text');
            
            if (select2Container && inputGroupText) {
                select2Container.addEventListener('focusin', () => {
                    inputGroupText.style.borderColor = 'var(--info)';
                });
                
                select2Container.addEventListener('focusout', () => {
                    inputGroupText.style.borderColor = '#ced4da';
                });
            }
        });

        // Initialize church select as disabled
        if (!$('#{{ form.pastorate.id_for_label }}').val()) {
            $('#{{ form.church.id_for_label }}').prop('disabled', true);
        }
    });
</script>
{% endblock %} 